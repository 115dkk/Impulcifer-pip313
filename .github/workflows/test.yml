name: Tests

on:
  push:
    branches: [ main, master, develop, claude/* ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12", "3.13"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install dependencies
      run: |
        uv pip install --system -r requirements-dev.txt

    - name: Run unit tests
      run: |
        python -m pytest tests/test_suite.py -v

    - name: Run pytest with coverage
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  test-imports:
    name: Test Module Imports
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install package
      run: |
        uv pip install --system -e .

    - name: Test core imports
      run: |
        python -c "import impulcifer; print('✓ impulcifer')"
        python -c "from core.hrir import HRIR; print('✓ core.hrir')"
        python -c "from core.impulse_response import ImpulseResponse; print('✓ core.impulse_response')"
        python -c "from core.microphone_deviation_correction import MicrophoneDeviationCorrector; print('✓ core.microphone_deviation_correction')"
        python -c "from i18n.localization import get_localization_manager; print('✓ i18n.localization')"
        python -c "from infra.logger import get_logger; print('✓ infra.logger')"
        python -c "from updater.update_checker import UpdateChecker; print('✓ updater.update_checker')"

    - name: Test audio/GUI imports (optional - requires PortAudio)
      continue-on-error: true
      run: |
        python -c "import core.recorder; print('✓ core.recorder')"
        python -c "from gui.modern_gui import main_gui; print('✓ gui.modern_gui')"
        python -c "from gui.legacy_gui import main_gui; print('✓ gui.legacy_gui')"

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install ruff
      run: |
        uv pip install --system ruff

    - name: Run ruff linter
      continue-on-error: true
      run: |
        ruff check . --output-format=github

    - name: Check Python syntax
      run: |
        python -m py_compile *.py
        python -m py_compile core/*.py gui/*.py i18n/*.py infra/*.py updater/*.py

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, test-imports, lint]
    if: always()
    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.test-imports.result }}" = "success" ]; then
          echo "✅ All tests passed!"
          exit 0
        else
          echo "❌ Some tests failed"
          echo "  test: ${{ needs.test.result }}"
          echo "  test-imports: ${{ needs.test-imports.result }}"
          echo "  lint: ${{ needs.lint.result }}"
          exit 1
        fi
