name: Cross-Platform Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Windows 빌드
  build-windows:
    name: Build Windows Distribution
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Cache Nuitka compilation
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka\Nuitka\Cache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Install build requirements and project dependencies
        run: |
          echo "[1/3] Installing required packages with uv (ultra-fast Python package installer)..."
          uv pip install --system nuitka
          if python -c "import sys; exit(0) if sys.version_info.major == 3 and sys.version_info.minor >= 11 else exit(1)"; then
            echo "Python 3.11+ detected, tomllib is available."
          else
            echo "Python < 3.11 detected, installing toml package."
            uv pip install --system toml
          fi
          echo "Installing project dependencies from requirements.txt..."
          uv pip install --system -r requirements.txt
          echo "All dependencies installed successfully with uv!"
        shell: bash

      - name: Read project version and set APP_VERSION
        run: |
          python get_version.py
          APP_VERSION=$(python get_version.py)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "Building version: $APP_VERSION"
        shell: bash

      - name: Run Nuitka build using build_nuitka.py
        run: |
          echo "[2/3] Starting optimized Nuitka build for Windows..."
          python build_nuitka.py
          echo "NUITKA_OUTPUT_DIR=${{ github.workspace }}\dist\Impulcifer_Distribution\ImpulciferGUI" >> $GITHUB_ENV
          echo "PROJECT_ROOT_FOR_ISS=${{ github.workspace }}" >> $GITHUB_ENV
          echo "ISS_PATH=${{ github.workspace }}\.github\workflows\Output" >> $GITHUB_ENV
          echo "Successfully built with Nuitka (optimized)."
        shell: bash
        env:
          PYTHONIOENCODING: UTF-8

      - name: Set up Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: .github/workflows/Impulcifer install maker.iss
          options: /DNUITKA_BUILD_DIR="${{ env.NUITKA_OUTPUT_DIR }}" /DAPP_VERSION="${{ env.APP_VERSION }}" /DPROJECT_ROOT_FOR_ISS="${{ env.PROJECT_ROOT_FOR_ISS }}" /DISS_PATH="${{ env.ISS_PATH }}"

      - name: Set installer path
        run: |
          echo "INSTALLER_PATH=${{ env.ISS_PATH }}\Impulcifer_Setup.exe" >> $GITHUB_ENV
        shell: bash

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: ${{ env.INSTALLER_PATH }}
          retention-days: 30

  # macOS 빌드
  build-macos:
    name: Build macOS Distribution
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Cache Nuitka compilation
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Install build requirements and project dependencies
        run: |
          echo "Installing required packages with uv..."
          uv pip install --system nuitka ordered-set
          if python -c "import sys; exit(0) if sys.version_info.major == 3 and sys.version_info.minor >= 11 else exit(1)"; then
            echo "Python 3.11+ detected, tomllib is available."
          else
            uv pip install --system toml
          fi
          uv pip install --system -r requirements.txt
          echo "All dependencies installed successfully!"

      - name: Read project version
        run: |
          APP_VERSION=$(python get_version.py)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      - name: Run Nuitka build for macOS
        run: |
          echo "Starting Nuitka build for macOS..."
          python -m nuitka \
            --standalone \
            --macos-create-app-bundle \
            --macos-app-name="Impulcifer" \
            --output-dir=dist/macos \
            --remove-output \
            --jobs=4 \
            --lto=no \
            --enable-plugin=tk-inter \
            --enable-plugin=numpy \
            --enable-plugin=matplotlib \
            --include-package=customtkinter \
            --include-module=sounddevice \
            --include-module=soundfile \
            --include-module=scipy \
            --include-module=scipy.signal \
            --include-module=scipy.optimize \
            --include-module=scipy.interpolate \
            --include-module=scipy.io \
            --include-module=scipy.fft \
            --include-module=nnresample \
            --include-module=tabulate \
            --include-module=seaborn \
            --include-module=bokeh \
            --include-module=autoeq \
            --include-module=modern_gui \
            --include-module=gui \
            --include-module=localization \
            --include-module=logger \
            --include-module=channel_generation \
            --include-module=update_checker \
            --include-module=updater \
            --include-module=recorder \
            --include-module=impulcifer \
            --include-module=hrir \
            --include-module=impulse_response \
            --include-module=impulse_response_estimator \
            --include-module=room_correction \
            --include-module=microphone_deviation_correction \
            --include-module=utils \
            --include-module=constants \
            --include-data-dir=data=data \
            --include-data-dir=font=font \
            --include-data-dir=img=img \
            --include-data-dir=locales=locales \
            --include-data-file=LICENSE=License.txt \
            --include-data-file=README.txt=README.txt \
            --output-filename=Impulcifer \
            --company-name=115dkk \
            --product-name=Impulcifer \
            --file-version=${{ env.APP_VERSION }} \
            --product-version=${{ env.APP_VERSION }} \
            --file-description="HRIR 측정 및 헤드폰 바이노럴 헤드트래킹 HRTF 시스템" \
            --prefer-source-code \
            --assume-yes-for-downloads \
            --show-progress \
            --show-memory \
            gui_main.py

          echo "Checking macOS build output:"
          ls -la dist/macos/

          # Rename gui_main.app to Impulcifer.app if needed
          if [ -d "dist/macos/gui_main.app" ]; then
            echo "Renaming gui_main.app to Impulcifer.app..."
            mv dist/macos/gui_main.app dist/macos/Impulcifer.app
          fi

          echo "Final macOS build structure:"
          ls -la dist/macos/
        env:
          PYTHONIOENCODING: UTF-8

      - name: Create DMG installer
        run: |
          echo "Creating DMG installer..."
          brew install create-dmg || true
          mkdir -p dist/dmg

          # 경로 확인 디버깅용 출력
          echo "Checking dist/macos contents:"
          ls -R dist/macos

          # .app 파일 복사 (없으면 에러 발생시키고 종료)
          if [ -d "dist/macos/Impulcifer.app" ]; then
            echo "Found Impulcifer.app, copying to dist/dmg/"
            cp -R dist/macos/Impulcifer.app dist/dmg/
          else
            echo "Error: Impulcifer.app not found in dist/macos!"
            echo "Searching for any .app files..."
            find dist/macos -name "*.app" -type d
            exit 1
          fi

          # DMG 생성
          create-dmg \
            --volname "Impulcifer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            --hdiutil-quiet \
            "dist/Impulcifer-${{ env.APP_VERSION }}-macOS.dmg" \
            "dist/dmg/"

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/Impulcifer-*.dmg
          retention-days: 30
          if-no-files-found: warn

  # Linux 빌드
  build-linux:
    name: Build Linux Distribution
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            patchelf \
            desktop-file-utils \
            libfuse2 \
            imagemagick \
            portaudio19-dev \
            python3-tk \
            python3-dev \
            libasound2-dev \
            libportaudio2 \
            libportmidi-dev \
            libhdf5-dev \
            libatlas-base-dev \
            gfortran \
            libopenblas-dev

      - name: Cache Nuitka compilation
        uses: actions/cache@v4
        with:
          path: ~/.cache/Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Install build requirements and project dependencies
        run: |
          echo "Installing required packages with uv..."
          uv pip install --system nuitka ordered-set patchelf
          if python -c "import sys; exit(0) if sys.version_info.major == 3 and sys.version_info.minor >= 11 else exit(1)"; then
            echo "Python 3.11+ detected, tomllib is available."
          else
            uv pip install --system toml
          fi
          uv pip install --system -r requirements.txt
          echo "All dependencies installed successfully!"

      - name: Read project version
        run: |
          APP_VERSION=$(python get_version.py)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV

      - name: Run Nuitka build for Linux
        run: |
          echo "Starting Nuitka build for Linux (standalone for AppImage)..."
          python -m nuitka \
            --standalone \
            --output-dir=dist/linux \
            --remove-output \
            --jobs=4 \
            --lto=no \
            --enable-plugin=tk-inter \
            --enable-plugin=numpy \
            --enable-plugin=matplotlib \
            --include-package=customtkinter \
            --include-module=sounddevice \
            --include-module=soundfile \
            --include-module=scipy \
            --include-module=scipy.signal \
            --include-module=scipy.optimize \
            --include-module=scipy.interpolate \
            --include-module=scipy.io \
            --include-module=scipy.fft \
            --include-module=nnresample \
            --include-module=tabulate \
            --include-module=seaborn \
            --include-module=bokeh \
            --include-module=autoeq \
            --include-module=modern_gui \
            --include-module=gui \
            --include-module=localization \
            --include-module=logger \
            --include-module=channel_generation \
            --include-module=update_checker \
            --include-module=updater \
            --include-module=recorder \
            --include-module=impulcifer \
            --include-module=hrir \
            --include-module=impulse_response \
            --include-module=impulse_response_estimator \
            --include-module=room_correction \
            --include-module=microphone_deviation_correction \
            --include-module=utils \
            --include-module=constants \
            --include-data-dir=data=data \
            --include-data-dir=font=font \
            --include-data-dir=img=img \
            --include-data-dir=locales=locales \
            --include-data-file=LICENSE=License.txt \
            --include-data-file=README.txt=README.txt \
            --output-filename=Impulcifer \
            --company-name=115dkk \
            --product-name=Impulcifer \
            --file-version=${{ env.APP_VERSION }} \
            --product-version=${{ env.APP_VERSION }} \
            --file-description="HRIR 측정 및 헤드폰 바이노럴 헤드트래킹 HRTF 시스템" \
            --prefer-source-code \
            --assume-yes-for-downloads \
            --show-progress \
            --show-memory \
            gui_main.py

          echo "Checking Linux build output:"
          ls -la dist/linux/
        env:
          PYTHONIOENCODING: UTF-8

      - name: Create AppImage
        run: |
          echo "Creating AppImage from standalone folder..."
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # standalone 폴더 확인
          STANDALONE_DIR="dist/linux/gui_main.dist"
          if [ ! -d "$STANDALONE_DIR" ]; then
            echo "Error: Standalone folder not found at $STANDALONE_DIR"
            echo "Contents of dist/linux:"
            ls -la dist/linux/
            exit 1
          fi

          echo "Found standalone folder: $STANDALONE_DIR"
          echo "Contents:"
          ls -la "$STANDALONE_DIR"

          # AppDir 구조 생성 (standalone 폴더 전체를 포함)
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib/impulcifer
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # standalone 폴더 전체를 lib 디렉토리로 복사
          cp -r "$STANDALONE_DIR"/* AppDir/usr/lib/impulcifer/

          # 실행 파일 찾기
          EXEC_NAME=""
          if [ -f "AppDir/usr/lib/impulcifer/Impulcifer" ]; then
            EXEC_NAME="Impulcifer"
          elif [ -f "AppDir/usr/lib/impulcifer/Impulcifer.bin" ]; then
            EXEC_NAME="Impulcifer.bin"
          elif [ -f "AppDir/usr/lib/impulcifer/gui_main" ]; then
            EXEC_NAME="gui_main"
          elif [ -f "AppDir/usr/lib/impulcifer/gui_main.bin" ]; then
            EXEC_NAME="gui_main.bin"
          else
            echo "Error: Executable not found in standalone folder"
            find AppDir/usr/lib/impulcifer -type f -executable | head -10
            exit 1
          fi

          echo "Found executable: $EXEC_NAME"

          # 래퍼 스크립트 생성 (라이브러리 경로 설정)
          cat > AppDir/usr/bin/impulcifer <<'WRAPPER_EOF'
#!/bin/bash
SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
APP_DIR="$(dirname "$SCRIPT_DIR")"
export LD_LIBRARY_PATH="$APP_DIR/lib/impulcifer:$LD_LIBRARY_PATH"
exec "$APP_DIR/lib/impulcifer/EXEC_PLACEHOLDER" "$@"
WRAPPER_EOF
          sed -i "s/EXEC_PLACEHOLDER/$EXEC_NAME/g" AppDir/usr/bin/impulcifer
          chmod +x AppDir/usr/bin/impulcifer

          # Create desktop file (no indentation - Desktop Entry format requirement)
          {
            echo '[Desktop Entry]'
            echo 'Type=Application'
            echo 'Name=Impulcifer'
            echo 'Comment=HRIR 측정 및 헤드폰 바이노럴 헤드트래킹 HRTF 시스템'
            echo 'Exec=impulcifer'
            echo 'Icon=impulcifer'
            echo 'Categories=AudioVideo;Audio;'
            echo 'Terminal=false'
          } > AppDir/usr/share/applications/impulcifer.desktop

          # Create a simple placeholder icon (linuxdeploy requires an icon)
          # Using ImageMagick to create a 256x256 PNG with text
          convert -size 256x256 xc:none -gravity center \
            -pointsize 72 -fill '#4A90E2' \
            -draw "circle 128,128 128,28" \
            -pointsize 48 -fill white \
            -annotate +0+0 "I" \
            AppDir/usr/share/icons/hicolor/256x256/apps/impulcifer.png || \
          # Fallback: create solid color icon if ImageMagick fails
          convert -size 256x256 xc:'#4A90E2' \
            AppDir/usr/share/icons/hicolor/256x256/apps/impulcifer.png

          echo "AppDir structure:"
          ls -la AppDir/usr/bin/
          ls -la AppDir/usr/lib/impulcifer/ | head -20

          # Create AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage \
            --desktop-file=AppDir/usr/share/applications/impulcifer.desktop

          # Rename AppImage with proper version
          APPIMAGE_FILE=$(ls Impulcifer-*.AppImage 2>/dev/null | head -1)
          if [ -n "$APPIMAGE_FILE" ]; then
            echo "Found AppImage: $APPIMAGE_FILE"
            mv "$APPIMAGE_FILE" "Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage"
            echo "Renamed to: Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage"
          else
            echo "Error: AppImage was not created"
            exit 1
          fi

      - name: Create tarball distribution
        run: |
          echo "Creating tarball distribution from standalone folder..."

          # standalone 폴더 확인
          STANDALONE_DIR="dist/linux/gui_main.dist"
          if [ ! -d "$STANDALONE_DIR" ]; then
            echo "Error: Standalone folder not found"
            exit 1
          fi

          # 배포용 디렉토리 생성 (standalone 폴더 전체 복사)
          mkdir -p dist/Impulcifer-linux
          cp -r "$STANDALONE_DIR"/* dist/Impulcifer-linux/

          # Copy optional documentation files
          [ -f "README.txt" ] && cp README.txt dist/Impulcifer-linux/ && echo "Copied README.txt"
          [ -f "LICENSE" ] && cp LICENSE dist/Impulcifer-linux/ && echo "Copied LICENSE"

          # 실행 파일 이름 찾기
          EXEC_NAME=""
          if [ -f "dist/Impulcifer-linux/Impulcifer" ]; then
            EXEC_NAME="Impulcifer"
          elif [ -f "dist/Impulcifer-linux/Impulcifer.bin" ]; then
            EXEC_NAME="Impulcifer.bin"
          elif [ -f "dist/Impulcifer-linux/gui_main" ]; then
            EXEC_NAME="gui_main"
          elif [ -f "dist/Impulcifer-linux/gui_main.bin" ]; then
            EXEC_NAME="gui_main.bin"
          fi

          # Create run script
          cat > dist/Impulcifer-linux/run.sh <<RUNSCRIPT_EOF
#!/bin/bash
SCRIPT_DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
cd "\$SCRIPT_DIR"
./$EXEC_NAME "\$@"
RUNSCRIPT_EOF
          chmod +x dist/Impulcifer-linux/run.sh

          echo "Tarball contents:"
          ls -lah dist/Impulcifer-linux/ | head -20

          # Create tarball
          cd dist
          tar czf "Impulcifer-${{ env.APP_VERSION }}-linux-x86_64.tar.gz" Impulcifer-linux
          cd ..

          echo "Tarball created: dist/Impulcifer-${{ env.APP_VERSION }}-linux-x86_64.tar.gz"

      - name: Upload Linux AppImage
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: Impulcifer-*.AppImage
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Linux tarball
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: dist/Impulcifer-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

  # 통합 릴리스 생성
  create-release:
    name: Create Cross-Platform Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Get version
        run: |
          APP_VERSION=$(python get_version.py)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "Version: $APP_VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts/

      - name: Generate Release Tag and Notes
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            TAG_NAME="${{ github.ref_name }}"
          else
            TAG_NAME="v${{ env.APP_VERSION }}-$(date +'%Y%m%d%H%M%S')"
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "Generated tag: $TAG_NAME"

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          COMMIT_RANGE=""
          if [ -z "$LAST_TAG" ]; then
            COMMIT_RANGE="HEAD"
          else
            COMMIT_RANGE="$LAST_TAG..HEAD"
          fi

          CHANGELOG_BODY=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $COMMIT_RANGE)

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Impulcifer ${{ env.APP_VERSION }} - Cross-Platform Release"
          body: |
            # Impulcifer ${{ env.APP_VERSION }} - Cross-Platform Release

            이제 **Windows, macOS, Linux** 모든 플랫폼에서 Impulcifer를 사용할 수 있습니다!

            ## 다운로드

            ### Windows
            - `Impulcifer_Setup.exe` - Windows 인스톨러 (권장)

            ### macOS
            - `Impulcifer-*-macOS.dmg` - macOS DMG 이미지

            ### Linux
            - `Impulcifer-*-x86_64.AppImage` - AppImage (모든 배포판)
            - `Impulcifer-*-linux-x86_64.tar.gz` - Tarball 아카이브

            ## 변경사항

            ${{ env.RELEASE_NOTES }}

            ---

            ## Installation Instructions

            ### Windows
            1. Download `Impulcifer_Setup.exe`
            2. Run the installer
            3. Follow the installation wizard

            ### macOS
            1. Download `Impulcifer-*-macOS.dmg`
            2. Open the DMG file
            3. Drag Impulcifer to Applications folder

            ### Linux

            **AppImage (권장):**
            ```bash
            chmod +x Impulcifer-*.AppImage
            ./Impulcifer-*.AppImage
            ```

            **Tarball:**
            ```bash
            tar xzf Impulcifer-*-linux-x86_64.tar.gz
            cd Impulcifer-linux
            ./run.sh
            ```
          files: |
            artifacts/windows-installer/*
            artifacts/macos-dmg/*
            artifacts/linux-appimage/*
            artifacts/linux-tarball/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
