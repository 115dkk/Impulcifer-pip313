name: Build Linux Distribution

# 이 워크플로우는 개별 빌드용입니다
# master push 시 자동 실행되지 않으며, workflow_dispatch(수동)나 workflow_call(호출)로만 실행됩니다
# 통합 릴리스는 release-cross-platform.yml을 사용합니다
on:
  workflow_dispatch:
  workflow_call:
    outputs:
      artifact-name:
        description: "Name of the Linux build artifact"
        value: ${{ jobs.build-linux.outputs.artifact-name }}

jobs:
  build-linux:
    name: Build Linux Application
    runs-on: ubuntu-latest
    outputs:
      artifact-name: linux-distribution

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install system dependencies
        run: |
          echo "Installing system dependencies for Linux build..."
          sudo apt-get update
          sudo apt-get install -y \
            patchelf \
            desktop-file-utils \
            libfuse2 \
            portaudio19-dev \
            python3-tk \
            python3-dev \
            libasound2-dev \
            libportaudio2 \
            libportmidi-dev \
            libhdf5-dev \
            libatlas-base-dev \
            gfortran \
            libopenblas-dev

      - name: Cache Nuitka compilation
        uses: actions/cache@v4
        with:
          path: ~/.cache/Nuitka
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/*.py') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Install build requirements and project dependencies
        run: |
          echo "[1/4] Installing required packages with uv (ultra-fast Python package installer)..."
          uv pip install --system nuitka ordered-set patchelf
          if python -c "import sys; exit(0) if sys.version_info.major == 3 and sys.version_info.minor >= 11 else exit(1)"; then
            echo "Python 3.11+ detected, tomllib is available."
          else
            echo "Python < 3.11 detected, installing toml package."
            uv pip install --system toml
          fi
          echo "Installing project dependencies from requirements.txt..."
          uv pip install --system -r requirements.txt
          echo "All dependencies installed successfully with uv!"

      - name: Read project version and set APP_VERSION
        run: |
          APP_VERSION=$(python infra/get_version.py)
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "Building version: $APP_VERSION"

      - name: Run Nuitka build for Linux
        run: |
          echo "[2/4] Starting optimized Nuitka build for Linux..."
          echo "Build optimizations enabled:"
          echo "  - Multi-core compilation (--jobs=4)"
          echo "  - LTO disabled for faster builds (--lto=no)"
          echo "  - Nuitka cache enabled"
          echo ""

          # Linux용 빌드 스크립트 실행 (standalone 폴더 생성 - AppImage로 패키징됨)
          python -m nuitka \
            --standalone \
            --output-dir=dist/linux \
            --remove-output \
            --jobs=4 \
            --lto=no \
            --enable-plugin=tk-inter \
            --enable-plugin=numpy \
            --enable-plugin=matplotlib \
            --include-package=customtkinter \
            --include-module=sounddevice \
            --include-module=soundfile \
            --include-module=scipy \
            --include-module=scipy.signal \
            --include-module=scipy.optimize \
            --include-module=scipy.interpolate \
            --include-module=scipy.io \
            --include-module=scipy.fft \
            --include-module=nnresample \
            --include-module=tabulate \
            --include-module=seaborn \
            --include-module=bokeh \
            --include-module=autoeq \
            --include-module=modern_gui \
            --include-module=gui \
            --include-module=localization \
            --include-module=logger \
            --include-module=channel_generation \
            --include-module=update_checker \
            --include-module=updater \
            --include-module=recorder \
            --include-module=impulcifer \
            --include-module=hrir \
            --include-module=impulse_response \
            --include-module=impulse_response_estimator \
            --include-module=room_correction \
            --include-module=microphone_deviation_correction \
            --include-module=utils \
            --include-module=constants \
            --include-data-dir=data=data \
            --include-data-dir=font=font \
            --include-data-dir=img=img \
            --include-data-dir=locales=locales \
            --include-data-file=LICENSE=License.txt \
            --include-data-file=README.txt=README.txt \
            --output-filename=Impulcifer \
            --company-name=115dkk \
            --product-name=Impulcifer \
            --file-version=${{ env.APP_VERSION }} \
            --product-version=${{ env.APP_VERSION }} \
            --file-description="HRIR 측정 및 헤드폰 바이노럴 헤드트래킹 HRTF 시스템" \
            --prefer-source-code \
            --assume-yes-for-downloads \
            --show-progress \
            --show-memory \
            gui_main.py

          echo "Successfully built with Nuitka for Linux."
        env:
          PYTHONIOENCODING: UTF-8

      - name: Create AppImage
        run: |
          echo "[3/4] Creating AppImage from standalone folder..."

          # Use appimagetool directly (Nuitka standalone already bundles all dependencies)
          # linuxdeploy causes issues with scipy's internal OpenBLAS libraries
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # standalone 폴더 확인
          STANDALONE_DIR="dist/linux/gui_main.dist"
          if [ ! -d "$STANDALONE_DIR" ]; then
            echo "Error: Standalone folder not found at $STANDALONE_DIR"
            echo "Contents of dist/linux:"
            ls -la dist/linux/
            exit 1
          fi

          echo "Found standalone folder: $STANDALONE_DIR"
          echo "Contents:"
          ls -la "$STANDALONE_DIR"

          # AppDir 구조 생성 (standalone 폴더 전체를 포함)
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib/impulcifer
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/metainfo

          # standalone 폴더 전체를 lib 디렉토리로 복사
          cp -r "$STANDALONE_DIR"/* AppDir/usr/lib/impulcifer/

          # 실행 파일 찾기
          EXEC_NAME=""
          if [ -f "AppDir/usr/lib/impulcifer/Impulcifer" ]; then
            EXEC_NAME="Impulcifer"
          elif [ -f "AppDir/usr/lib/impulcifer/Impulcifer.bin" ]; then
            EXEC_NAME="Impulcifer.bin"
          elif [ -f "AppDir/usr/lib/impulcifer/gui_main" ]; then
            EXEC_NAME="gui_main"
          elif [ -f "AppDir/usr/lib/impulcifer/gui_main.bin" ]; then
            EXEC_NAME="gui_main.bin"
          else
            echo "Error: Executable not found in standalone folder"
            find AppDir/usr/lib/impulcifer -type f -executable | head -10
            exit 1
          fi

          echo "Found executable: $EXEC_NAME"

          # Create AppRun script (required by AppImage)
          {
            echo '#!/bin/bash'
            echo 'SELF=$(readlink -f "$0")'
            echo 'HERE=${SELF%/*}'
            echo 'export PATH="${HERE}/usr/bin:${PATH}"'
            echo 'export LD_LIBRARY_PATH="${HERE}/usr/lib/impulcifer:${LD_LIBRARY_PATH}"'
            echo 'exec "${HERE}/usr/lib/impulcifer/'"$EXEC_NAME"'" "$@"'
          } > AppDir/AppRun
          chmod +x AppDir/AppRun

          # .desktop 파일 생성 (들여쓰기 없이)
          {
            echo '[Desktop Entry]'
            echo 'Type=Application'
            echo 'Name=Impulcifer'
            echo 'Comment=HRIR Measurement and Binaural Processing System'
            echo 'Exec=AppRun'
            echo 'Icon=impulcifer'
            echo 'Categories=AudioVideo;Audio;'
            echo 'Terminal=false'
          } > AppDir/impulcifer.desktop
          cp AppDir/impulcifer.desktop AppDir/usr/share/applications/

          # 아이콘 생성/복사
          if [ -f "img/icon.png" ]; then
            cp img/icon.png AppDir/impulcifer.png
          else
            # Create icon using ImageMagick
            convert -size 256x256 xc:none -gravity center \
              -pointsize 72 -fill '#4A90E2' \
              -draw "circle 128,128 128,28" \
              -pointsize 48 -fill white \
              -annotate +0+0 "I" \
              AppDir/impulcifer.png 2>/dev/null || \
            convert -size 256x256 xc:'#4A90E2' AppDir/impulcifer.png
          fi
          cp AppDir/impulcifer.png AppDir/usr/share/icons/hicolor/256x256/apps/
          cp AppDir/impulcifer.png AppDir/.DirIcon

          echo "AppDir structure:"
          ls -la AppDir/
          ls -la AppDir/usr/lib/impulcifer/ | head -20

          # Create AppImage using appimagetool (no dependency resolution - just packaging)
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir "Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage"

          if [ -f "Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage" ]; then
            echo "Successfully created: Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage"
            ls -lh "Impulcifer-${{ env.APP_VERSION }}-x86_64.AppImage"
          else
            echo "Error: AppImage was not created"
            exit 1
          fi

      - name: Create tarball distribution
        run: |
          echo "[4/4] Creating tarball distribution from standalone folder..."

          # standalone 폴더 확인
          STANDALONE_DIR="dist/linux/gui_main.dist"
          if [ ! -d "$STANDALONE_DIR" ]; then
            echo "Error: Standalone folder not found"
            exit 1
          fi

          # 배포용 디렉토리 생성 (standalone 폴더 전체 복사)
          mkdir -p dist/Impulcifer-linux
          cp -r "$STANDALONE_DIR"/* dist/Impulcifer-linux/

          # 문서 및 라이선스 복사
          cp README.txt dist/Impulcifer-linux/ || true
          cp LICENSE dist/Impulcifer-linux/ || true

          # 실행 파일 이름 찾기
          EXEC_NAME=""
          if [ -f "dist/Impulcifer-linux/Impulcifer" ]; then
            EXEC_NAME="Impulcifer"
          elif [ -f "dist/Impulcifer-linux/Impulcifer.bin" ]; then
            EXEC_NAME="Impulcifer.bin"
          elif [ -f "dist/Impulcifer-linux/gui_main" ]; then
            EXEC_NAME="gui_main"
          elif [ -f "dist/Impulcifer-linux/gui_main.bin" ]; then
            EXEC_NAME="gui_main.bin"
          fi

          # 실행 스크립트 생성
          {
            echo '#!/bin/bash'
            echo 'SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"'
            echo 'cd "$SCRIPT_DIR"'
            echo "./$EXEC_NAME \"\$@\""
          } > dist/Impulcifer-linux/run.sh
          chmod +x dist/Impulcifer-linux/run.sh

          # tarball 생성
          cd dist
          tar czf "Impulcifer-${{ env.APP_VERSION }}-linux-x86_64.tar.gz" Impulcifer-linux
          cd ..

          echo "✅ Linux tarball distribution created."

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-distribution
          path: |
            Impulcifer-*.AppImage
            dist/Impulcifer-*.tar.gz
          retention-days: 30
          if-no-files-found: warn
